# -*- coding: utf-8 -*-
from __future__ import division, print_function, absolute_import

import numpy as np
import tflearn
import h5py
import os

print('loading dataset...')

h5f_train = h5py.File("../dataset/test_dataset_227.h5", 'r')

X = h5f_train['X']

# load Model
import googlenet

network = googlenet.GetNetwork(9)

model = tflearn.DNN(network)
model.load('../model/googlenet_malware_600epoch.tfl')

import csv
fp = open("../tmp/predict.csv", 'w')
writer = csv.writer(fp)
writer.writerows([['Id', 'Prediction1', 'Prediction2','Prediction3','Prediction4','Prediction5','Prediction6','Prediction7','Prediction8','Prediction9']])

files = os.listdir('../test')

for i in range(len(X)):
    result = model.predict(X[i].reshape([-1,227,227,3]))
    row = [files[i][0:-4]]
    for cur in result[0]:
        row.append(cur)
    writer.writerows([row])
    if i%100 is 0:
        print(i)
fp.close()
print('done')
